<!DOCTYPE html>
<html>
<head>
  <title>Cloudflare KV Editor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
</head>
<body>
  <h1>Cloudflare KV Editor</h1>
  <hr>

  <div>
    <label for="keyAddress">Key地址：</label>
    <input type="text" id="keyAddress">

    <label for="encryptionKey">密钥：</label>
    <input type="password" id="encryptionKey">
  </div>

  <hr>

  <button onclick="loadKeyData()">获取密钥数据</button>

  <h3>密钥数据：</h3>
  <pre id="keyData"></pre>

  <hr>

  <div>
    <label for="apiKey">API Key：</label>
    <input type="text" id="apiKey">
  </div>

  <div>
    <label for="apiToken">API Token：</label>
    <input type="text" id="apiToken">
  </div>

  <div>
    <label for="namespaceId">Namespace ID：</label>
    <input type="text" id="namespaceId">
  </div>

  <hr>

  <button onclick="listKeyValues()">点击列出列表</button>

  <h3>列表：</h3>
  <div id="keyValueList"></div>

  <hr>

  <h3>创建：</h3>
  <input type="text" id="keyInput" placeholder="请输入键">
  <input type="text" id="valueInput" placeholder="请输入值">
  <button onclick="createOrUpdateKeyValue()">点击创建/更新</button>

  <hr>

  <h3>删除：</h3>
  <input type="text" id="deleteKeyInput" placeholder="请输入要删除的键">
  <button onclick="deleteKeyValue()">点击删除</button>

  <script>
    // 解密函数
    async function decryptData(data, encryptionKey) {
      try {
        var bytes = CryptoJS.AES.decrypt(data, encryptionKey);
        var decryptedData = bytes.toString(CryptoJS.enc.Utf8);
        return decryptedData;
      } catch (error) {
        throw new Error('解密出现错误：' + error);
      }
    }

    // 获取密钥数据
    async function loadKeyData() {
      var keyAddress = document.getElementById('keyAddress').value.trim();
      var encryptionKey = document.getElementById('encryptionKey').value.trim();

      if (keyAddress === '' || encryptionKey === '') {
        alert('请输入Key地址和密钥');
        return;
      }

      try {
        var response = await fetch(keyAddress);
        var jsonData = await response.json();

        var encryptedApiKey = jsonData.apiKey;
        var encryptedApiToken = jsonData.apiToken;
        var encryptedNamespaceId = jsonData.namespaceId;

        var apiKey = await decryptData(encryptedApiKey, encryptionKey);
        var apiToken = await decryptData(encryptedApiToken, encryptionKey);
        var namespaceId = await decryptData(encryptedNamespaceId, encryptionKey);

        document.getElementById('apiKey').value = apiKey;
        document.getElementById('apiToken').value = apiToken;
        document.getElementById('namespaceId').value = namespaceId;

        var keyData = {
          apiKey: apiKey,
          apiToken: apiToken,
          namespaceId: namespaceId
        };

        document.getElementById('keyData').textContent = JSON.stringify(keyData, null, 2);
      } catch (error) {
        alert('获取密钥数据出错：' + error);
      }
    }

    // 列出键值对
    async function listKeyValues() {
      var apiKey = document.getElementById('apiKey').value.trim();
      var apiToken = document.getElementById('apiToken').value.trim();
      var namespaceId = document.getElementById('namespaceId').value.trim();

      if (apiKey === '' || apiToken === '' || namespaceId === '') {
        alert('请输入API Key、API Token和Namespace ID');
        return;
      }

      try {
        var apiUrl = `https://api.cloudflare.com/client/v4/accounts/${apiKey}/storage/kv/namespaces/${namespaceId}/values`;
        const response = await fetch(apiUrl, {
          headers: {
            'Authorization': `Bearer ${apiToken}`,
            'X-Auth-Email': apiKey,
          },
        });

        const data = await response.json();
        alert('列出列表结果：' + JSON.stringify(data.result));

        var keyValueList = document.getElementById('keyValueList');
        keyValueList.innerHTML = '';
        for (const key in data.result) {
          keyValueList.innerHTML += `<p>${key} => ${data.result[key]}</p>`;
        }
      } catch (error) {
        alert('出现错误：' + error);
      }
    }

    // 创建或更新键值对
    async function createOrUpdateKeyValue() {
      var apiKey = document.getElementById('apiKey').value.trim();
      var apiToken = document.getElementById('apiToken').value.trim();
      var namespaceId = document.getElementById('namespaceId').value.trim();
      var key = document.getElementById('keyInput').value.trim();
      var value = document.getElementById('valueInput').value;

      if (apiKey === '' || apiToken === '' || namespaceId === '' || key === '' || value === '') {
        alert('请输入API Key、API Token、Namespace ID、键和值');
        return;
      }

      try {
        var apiUrl = `https://api.cloudflare.com/client/v4/accounts/${apiKey}/storage/kv/namespaces/${namespaceId}/values/${key}`;
        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${apiToken}`,
            'X-Auth-Email': apiKey,
            'Content-Type': 'text/plain',
          },
          body: value,
        });

        const data = await response.json();
        alert('创建/更新结果：' + JSON.stringify(data.result));

      } catch (error) {
        alert('出现错误：' + error);
      }
    }

    // 删除键值对
    async function deleteKeyValue() {
      var apiKey = document.getElementById('apiKey').value.trim();
      var apiToken = document.getElementById('apiToken').value.trim();
      var namespaceId = document.getElementById('namespaceId').value.trim();
      var key = document.getElementById('deleteKeyInput').value.trim();

      if (apiKey === '' || apiToken === '' || namespaceId === '' || key === '') {
        alert('请输入API Key、API Token、Namespace ID及要删除的键');
        return;
      }

      try {
        var apiUrl = `https://api.cloudflare.com/client/v4/accounts/${apiKey}/storage/kv/namespaces/${namespaceId}/values/${key}`;
        const response = await fetch(apiUrl, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${apiToken}`,
            'X-Auth-Email': apiKey,
          },
        });

        const data = await response.json();
        alert('删除结果：' + JSON.stringify(data.result));

      } catch (error) {
        alert('出现错误：' + error);
      }
    }
  </script>
</body>
</html>