<!DOCTYPE html>
<html>
<head>
  <title>Cloudflare KV Editor</title>
  <script src="https://ghsrc.wyf9.top/jsc/crypto.js"></script>
</head>
<body>
  <h1>Cloudflare KV Editor</h1>
  <hr>

  <div>
    <label for="keyAddress">Key地址：</label>
    <input type="text" id="keyAddress">
    
    <label for="encryptionKey">密钥：</label>
    <input type="password" id="encryptionKey">
  </div>
  
  <hr>
  
  <button onclick="listKeyValues()">点击列出列表</button>
  
  <h3>列表：</h3>
  <div id="keyValueList"></div>
  
  <hr>
  
  <h3>创建：</h3>
  <input type="text" id="keyInput" placeholder="请输入键">
  <input type="text" id="valueInput" placeholder="请输入值">
  <button onclick="createOrUpdateKeyValue()">点击创建/更新</button>
  
  <hr>
  
  <h3>删除：</h3>
  <input type="text" id="deleteKeyInput" placeholder="请输入要删除的键">
  <button onclick="deleteKeyValue()">点击删除</button>
  
  <hr>
  
  <h3>密钥格式（JSON）：</h3>
  
  <pre id="encryptionKeyJSON"></pre>
  
  <script>
    // 默认加密密钥
    let encryptionKey = '';

    // 解密函数
    function decryptData(data, encryptionKey) {
      var decryptedData;
      
      try {
        var bytes = CryptoJS.AES.decrypt(data, encryptionKey);
        decryptedData = bytes.toString(CryptoJS.enc.Utf8);
      } catch (error) {
        console.error('解密出现错误：', error);
      }
      
      return decryptedData;
    }

    // 网页初始化
    function initialize() {
      // 输入密钥
      document.getElementById('encryptionKey').addEventListener('input', function() {
        encryptionKey = this.value;
      });
    }

    // 列出键值对
    async function listKeyValues() {
      const keyAddress = document.getElementById('keyAddress').value.trim();

      if (keyAddress === '') {
        console.error('请输入Key地址');
        return;
      }

      try {
        const apiUrl = `https://api.cloudflare.com/client/v4/accounts/${encryptionKey}/storage/kv/namespaces/${keyAddress}/values`;
        
        const response = await fetch(apiUrl, {
          headers: {
            'Authorization': `Bearer ${encryptionKey}`,
            'X-Auth-Email': encryptionKey,
          },
        });

        const data = await response.json();
        console.log(data.result);

        // 更新页面上的键值对列表
        var keyValueList = document.getElementById('keyValueList');
        keyValueList.innerHTML = '';
        for (const key in data.result) {
          keyValueList.innerHTML += `<p>${key} => ${data.result[key]}</p>`;
        }
      } catch (error) {
        console.error('出现错误：', error);
      }
    }
    
    // 创建或更新键值对
    async function createOrUpdateKeyValue() {
      const keyAddress = document.getElementById('keyAddress').value.trim();
      const key = document.getElementById('keyInput').value.trim();
      const value = document.getElementById('valueInput').value;

      if (keyAddress === '') {
        console.error('请输入Key地址');
        return;
      }

      if (key === '' || value === '') {
        console.error('请输入键和值');
        return;
      }

      try {
        const apiUrl = `https://api.cloudflare.com/client/v4/accounts/${encryptionKey}/storage/kv/namespaces/${keyAddress}/values/${key}`;

        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${encryptionKey}`,
            'X-Auth-Email': encryptionKey,
            'Content-Type': 'text/plain',
          },
          body: value,
        });

        const data = await response.json();
        console.log(data.result);

        // 可使用数据来更新页面的 UI
      } catch (error) {
        console.error('出现错误：', error);
      }
    }

    // 删除键值对
    async function deleteKeyValue() {
      const keyAddress = document.getElementById('keyAddress').value.trim();
      const key = document.getElementById('deleteKeyInput').value.trim();

      if (keyAddress === '') {
        console.error('请输入Key地址');
        return;
      }

      if (key === '') {
        console.error('请输入要删除的键');
        return;
      }

      try {
        const apiUrl = `https://api.cloudflare.com/client/v4/accounts/${encryptionKey}/storage/kv/namespaces/${keyAddress}/values/${key}`;

        const response = await fetch(apiUrl, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${encryptionKey}`,
            'X-Auth-Email': encryptionKey,
          },
        });

        const data = await response.json();
        console.log(data.result);

        // 可使用数据来更新页面的 UI
      } catch (error) {
        console.error('出现错误：', error);
      }
    }

    // 页面初始化
    initialize();
  </script>
</body>
</html>
