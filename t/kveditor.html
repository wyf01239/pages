<!DOCTYPE html>
<html>

<head>
  <title>Cloudflare KV Editor</title>
  <script src="https://ghsrc.wyf9.top/jsc/crypto.js"></script>
</head>

<body>
  <h1>Cloudflare KV Editor</h1>
  <hr>

  <div>
    <label for="keyAddress">Key地址：</label>
    <input type="text" id="keyAddress">

    <label for="encryptionKey">密钥：</label>
    <input type="password" id="encryptionKey">
  </div>

  <hr>

  <button onclick="listKeyValues()">点击列出列表</button>

  <h3>列表：</h3>
  <div id="keyValueList"></div>

  <hr>

  <h3>创建：</h3>
  <input type="text" id="keyInput" placeholder="请输入键">
  <input type="text" id="valueInput" placeholder="请输入值">
  <button onclick="createOrUpdateKeyValue()">点击创建/更新</button>

  <hr>

  <h3>删除：</h3>
  <input type="text" id="deleteKeyInput" placeholder="请输入要删除的键">
  <button onclick="deleteKeyValue()">点击删除</button>

  <hr>

  <h3>密钥格式（JSON）：</h3>

  <pre id="encryptionKeyJSON"></pre>

  <script>
    // 解密函数
    function decryptData(data, encryptionKey) {
      try {
        var bytes = CryptoJS.AES.decrypt(data, encryptionKey);
        var decryptedData = bytes.toString(CryptoJS.enc.Utf8);
        return decryptedData;
      } catch (error) {
        alert('解密出现错误：' + error);
        return null;
      }
    }

    // 网页初始化
    function initialize() {
      document.getElementById('encryptionKey').addEventListener('input', function () {
        var encryptionKey = this.value;
        var encryptedKeyData = document.getElementById('encryptionKeyJSON').textContent.trim();
        var keyData = JSON.parse(decryptData(encryptedKeyData, encryptionKey));

        document.getElementById('apiKey').value = keyData.apiKey;
        document.getElementById('apiToken').value = keyData.apiToken;
        document.getElementById('namespaceId').value = keyData.namespaceId;
      });
    }

    // 列出键值对
    async function listKeyValues() {
      var encryptionKey = document.getElementById('encryptionKey').value.trim();
      var apiKey = document.getElementById('apiKey').value.trim();
      var apiToken = document.getElementById('apiToken').value.trim();
      var namespaceId = document.getElementById('namespaceId').value.trim();

      if (encryptionKey === '' || apiKey === '' || apiToken === '' || namespaceId === '') {
        alert('请输入完整的密钥和API信息');
        return;
      }

      try {
        var apiUrl = `https://api.cloudflare.com/client/v4/accounts/${apiKey}/storage/kv/namespaces/${namespaceId}/values`;
        const response = await fetch(apiUrl, {
          headers: {
            'Authorization': `Bearer ${decryptData(apiToken, encryptionKey)}`,
            'X-Auth-Email': apiKey,
          },
        });

        const data = await response.json();
        alert('列出列表结果：' + JSON.stringify(data.result));

        var keyValueList = document.getElementById('keyValueList');
        keyValueList.innerHTML = '';
        for (const key in data.result) {
          keyValueList.innerHTML += `<p>${key} => ${data.result[key]}</p>`;
        }
      } catch (error) {
        alert('出现错误：' + error);
      }
    }

    // 创建或更新键值对
    async function createOrUpdateKeyValue() {
      var encryptionKey = document.getElementById('encryptionKey').value.trim();
      var apiKey = document.getElementById('apiKey').value.trim();
      var apiToken = document.getElementById('apiToken').value.trim();
      var namespaceId = document.getElementById('namespaceId').value.trim();
      var key = document.getElementById('keyInput').value.trim();
      var value = document.getElementById('valueInput').value;

      if (encryptionKey === '' || apiKey === '' || apiToken === '' || namespaceId === '' || key === '' || value === '') {
        alert('请输入完整的密钥、API信息、键和值');
        return;
      }

      try {
        var apiUrl = `https://api.cloudflare.com/client/v4/accounts/${apiKey}/storage/kv/namespaces/${namespaceId}/values/${key}`;
        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${decryptData(apiToken, encryptionKey)}`,
            'X-Auth-Email': apiKey,
            'Content-Type': 'text/plain',
          },
          body: value,
        });

        const data = await response.json();
        alert('创建/更新结果：' + JSON.stringify(data.result));

      } catch (error) {
        alert('出现错误：' + error);
      }
    }

    // 删除键值对
    async function deleteKeyValue() {
      var encryptionKey = document.getElementById('encryptionKey').value.trim();
      var apiKey = document.getElementById('apiKey').value.trim();
      var apiToken = document.getElementById('apiToken').value.trim();
      var namespaceId = document.getElementById('namespaceId').value.trim();
      var key = document.getElementById('deleteKeyInput').value.trim();

      if (encryptionKey === '' || apiKey === '' || apiToken === '' || namespaceId === '' || key === '') {
        alert('请输入完整的密钥、API信息和键');
        return;
      }

      try {
        var apiUrl = `https://api.cloudflare.com/client/v4/accounts/${apiKey}/storage/kv/namespaces/${namespaceId}/values/${key}`;
        const response = await fetch(apiUrl, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${decryptData(apiToken, encryptionKey)}`,
            'X-Auth-Email': apiKey,
          },
        });

        const data = await response.json();
        alert('删除结果：' + JSON.stringify(data.result));

      } catch (error) {
        alert('出现错误：' + error);
      }
    }

    initialize();
  </script>
</body>

</html>